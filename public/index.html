<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Management System</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    header { background: #222; color: #fff; padding: 10px 20px; }
    nav a { color: #fff; margin-right: 15px; text-decoration: none; font-weight: bold; }
    nav a.active { text-decoration: underline; }
    main { padding: 20px; }
    section { display: none; }
    section.active { display: block; }
    h2 { margin-top: 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #eee; }
    .near-expiry { background: #fff3cd; }
    .expired { background: #f8d7da; }
    .form-row { margin-bottom: 8px; }
    label { display: inline-block; width: 140px; }
    input, select { padding: 5px; font-size: 14px; }
    button { padding: 6px 12px; margin: 4px 0; cursor: pointer; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 4px; margin-right: 6px; }
    .pill.cash { background: #d4edda; }
    .pill.online { background: #d1ecf1; }
    .pill.borrow { background: #f8d7da; }
    .card { background: #fff; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 0 2px rgba(0,0,0,0.1); display: inline-block; min-width: 180px; }
    .flex { display: flex; flex-wrap: wrap; gap: 10px; }
  </style>
</head>
<body>
<header>
  <nav>
    <a href="#" data-section="dashboard" class="active">Dashboard</a>
    <a href="#" data-section="stock">Stock</a>
    <a href="#" data-section="expired">Expired</a>
    <a href="#" data-section="sales">Sales</a>
    <a href="#" data-section="bills">Sales Bills</a>
    <a href="#" data-section="borrowers">Borrowers</a>
  </nav>
</header>
<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Dashboard</h2>
    <div class="flex">
      <div class="card">
        <strong>Daily Sales</strong><br>
        ₹ <span id="dash-daily-total">0</span>
      </div>
      <div class="card">
        <strong>Monthly Sales</strong><br>
        ₹ <span id="dash-monthly-total">0</span>
      </div>
      <div class="card">
        <span class="pill cash">Cash</span>
        ₹ <span id="dash-daily-cash">0</span>
      </div>
      <div class="card">
        <span class="pill online">Online</span>
        ₹ <span id="dash-daily-online">0</span>
      </div>
      <div class="card">
        <span class="pill borrow">Borrow Sales</span>
        ₹ <span id="dash-daily-borrow">0</span>
      </div>
      <div class="card">
        <strong>Borrower Payments Today</strong><br>
        ₹ <span id="dash-borrower-payments">0</span>
      </div>
    </div>
  </section>

  <!-- STOCK -->
  <section id="stock">
    <h2>Stock</h2>
    <h3>Add / Update Stock</h3>
    <div>
      <div class="form-row">
        <label>Product name:</label>
        <input id="stock-name" type="text">
      </div>
      <div class="form-row">
        <label>Price:</label>
        <input id="stock-price" type="number" step="0.01">
      </div>
      <div class="form-row">
        <label>Expiry date:</label>
        <input id="stock-expiry" type="date">
      </div>
      <div class="form-row">
        <label>Quantity:</label>
        <input id="stock-qty" type="number">
      </div>
      <button id="stock-add-btn">Add / Increase Stock</button>
      <div id="stock-msg"></div>
    </div>
    <h3>Current Stock</h3>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="stock-table-body"></tbody>
    </table>
  </section>

  <!-- EXPIRED -->
  <section id="expired">
    <h2>Expired Stock</h2>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Expired Date</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="expired-table-body"></tbody>
    </table>
  </section>

  <!-- SALES -->
  <section id="sales">
    <h2>Sales</h2>
    <div class="form-row">
      <label>Customer name:</label>
      <input id="sale-customer" type="text">
    </div>
    <div class="form-row">
      <label>Payment type:</label>
      <select id="sale-payment-type">
        <option value="CASH">CASH</option>
        <option value="ONLINE">ONLINE</option>
        <option value="BORROW">BORROW</option>
      </select>
    </div>
    <h3>Items</h3>
    <button id="sale-add-item">Add Item</button>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Qty</th>
          <th>Line Total</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody id="sale-items-body"></tbody>
    </table>
    <div class="form-row">
      <label>Total:</label>
      <span id="sale-total">0</span>
    </div>
    <div class="form-row">
      <label>Paid amount:</label>
      <input id="sale-paid" type="number" step="0.01" value="0">
    </div>
    <div class="form-row">
      <label>Remaining:</label>
      <span id="sale-remaining">0</span>
    </div>
    <button id="sale-save">Save Sale</button>
    <div id="sale-msg"></div>
  </section>

  <!-- SALES BILLS -->
  <section id="bills">
    <h2>Sales Bills</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Payment Type</th>
          <th>Total</th>
          <th>Paid</th>
          <th>Borrow</th>
        </tr>
      </thead>
      <tbody id="bills-table-body"></tbody>
    </table>
  </section>

  <!-- BORROWERS -->
  <section id="borrowers">
    <h2>Borrowers</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Outstanding</th>
          <th>Pay</th>
        </tr>
      </thead>
      <tbody id="borrowers-table-body"></tbody>
    </table>
  </section>
</main>

<script>
const API_BASE = '/api/server';

// --- NAVIGATION ---
document.querySelectorAll('nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    const sec = a.dataset.section;
    document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
    document.getElementById(sec).classList.add('active');

    if(sec==='dashboard') loadDashboard();
    if(sec==='stock') loadStock();
    if(sec==='expired') loadExpired();
    if(sec==='sales') loadSaleProducts();
    if(sec==='bills') loadBills();
    if(sec==='borrowers') loadBorrowers();
  });
});

// --- FETCH WRAPPER ---
async function fetchJSON(url, options){
  try{
    const res = await fetch(url, options);
    if(!res.ok){
      const text = await res.text();
      console.error(`HTTP ${res.status}: ${text}`);
      return null;
    }
    return await res.json();
  } catch(err){
    console.error('Fetch error:', err);
    return null;
  }
}

// --- DASHBOARD ---
async function loadDashboard(){
  const data = await fetchJSON(`${API_BASE}?route=dashboard`);
  if(!data) return;
  document.getElementById('dash-daily-total').textContent=Number(data.daily_total).toFixed(2);
  document.getElementById('dash-monthly-total').textContent=Number(data.monthly_total).toFixed(2);
  document.getElementById('dash-daily-cash').textContent=Number(data.daily_cash).toFixed(2);
  document.getElementById('dash-daily-online').textContent=Number(data.daily_online).toFixed(2);
  document.getElementById('dash-daily-borrow').textContent=Number(data.daily_borrow).toFixed(2);
  document.getElementById('dash-borrower-payments').textContent=Number(data.borrower_payments).toFixed(2);
}

// --- STOCK ---
async function loadStock(){
  const data = await fetchJSON(`${API_BASE}?route=stock`);
  if(!data) return;
  const tbody = document.getElementById('stock-table-body');
  tbody.innerHTML='';
  const today = new Date();
  data.forEach(row=>{
    const tr=document.createElement('tr');
    const exp = new Date(row.expiry_date);
    if((exp-today)/(1000*60*60*24)<=7) tr.classList.add('near-expiry');
    tr.innerHTML=`<td>${row.name}</td><td>${Number(row.price).toFixed(2)}</td><td>${row.expiry_date}</td><td>${row.quantity}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('stock-add-btn').addEventListener('click', async ()=>{
  const name=document.getElementById('stock-name').value.trim();
  const price=parseFloat(document.getElementById('stock-price').value);
  const expiry=document.getElementById('stock-expiry').value;
  const qty=parseInt(document.getElementById('stock-qty').value);
  const msgEl=document.getElementById('stock-msg'); msgEl.textContent='';
  if(!name||!price||!expiry||!qty){msgEl.textContent='Fill all fields'; return;}
  const data = await fetchJSON(`${API_BASE}?route=stock`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, price, expiry_date:expiry, quantity:qty})
  });
  if(data){msgEl.textContent='Stock saved'; document.getElementById('stock-name').value=''; document.getElementById('stock-price').value=''; document.getElementById('stock-expiry').value=''; document.getElementById('stock-qty').value=''; loadStock();}
  else msgEl.textContent='Error saving stock';
});

// --- EXPIRED ---
async function loadExpired(){
  const data = await fetchJSON(`${API_BASE}?route=expired`);
  if(!data) return;
  const tbody = document.getElementById('expired-table-body'); tbody.innerHTML='';
  data.forEach(row=>{
    const tr=document.createElement('tr'); tr.classList.add('expired');
    tr.innerHTML=`<td>${row.name}</td><td>${Number(row.price).toFixed(2)}</td><td>${row.expiry_date}</td><td>${row.expired_date}</td><td>${row.quantity}</td>`;
    tbody.appendChild(tr);
  });
}

// --- SALES PRODUCTS ---
let saleProducts=[];
async function loadSaleProducts(){
  const data = await fetchJSON(`${API_BASE}?route=sale-products`);
  if(!data) return;
  saleProducts = data;
  document.getElementById('sale-items-body').innerHTML='';
  recalcTotals();
}

// --- RE-CALCULATE TOTALS ---
function recalcTotals(){
  let total=0;
  document.querySelectorAll('#sale-items-body tr').forEach(tr=>{
    const price=parseFloat(tr.querySelector('.sale-price')?.textContent)||0;
    const qty=parseInt(tr.querySelector('.sale-qty')?.value)||0;
    const line=price*qty;
    tr.querySelector('.sale-line-total').textContent=line.toFixed(2);
    total+=line;
  });
  document.getElementById('sale-total').textContent=total.toFixed(2);
  const paid=parseFloat(document.getElementById('sale-paid').value)||0;
  let remaining = total-paid;
  if(remaining<0){document.getElementById('sale-paid').value=total.toFixed(2); remaining=0;}
  document.getElementById('sale-remaining').textContent=remaining.toFixed(2);
}

// --- ADD SALE ITEM ---
document.getElementById('sale-add-item').addEventListener('click',()=>{
  const tbody=document.getElementById('sale-items-body');
  const tr=document.createElement('tr');
  const options = saleProducts.map(p=>`<option value="${p.id}">${p.name}|₹${p.price}|Exp:${p.expiry_date}|Stock:${p.quantity}</option>`).join('');
  tr.innerHTML = `<td><select class="sale-product"><option value="">Select...</option>${options}</select></td>
                  <td class="sale-price">0</td>
                  <td class="sale-expiry"></td>
                  <td><input class="sale-qty" type="number" min="1" value="1"></td>
                  <td class="sale-line-total">0</td>
                  <td><button class="sale-remove">X</button></td>`;
  tbody.appendChild(tr);

  const sel = tr.querySelector('.sale-product');
  const qtyInput = tr.querySelector('.sale-qty');

  sel.addEventListener('change', ()=>{
    const id = parseInt(sel.value);
    const product = saleProducts.find(p=>p.id===id);
    if(product){
      tr.querySelector('.sale-price').textContent=Number(product.price).toFixed(2);
      tr.querySelector('.sale-expiry').textContent=product.expiry_date;
      if(parseInt(qtyInput.value)>product.quantity) qtyInput.value = product.quantity;
    } else { tr.querySelector('.sale-price').textContent='0'; tr.querySelector('.sale-expiry').textContent=''; }
    recalcTotals();
  });

  qtyInput.addEventListener('input', ()=>{
    const id = parseInt(sel.value);
    const product = saleProducts.find(p=>p.id===id);
    let qty=parseInt(qtyInput.value)||0;
    if(product && qty>product.quantity) qty=product.quantity;
    if(qty<1) qty=1; qtyInput.value=qty;
    recalcTotals();
  });

  tr.querySelector('.sale-remove').addEventListener('click',()=>{tr.remove(); recalcTotals();});
});

document.getElementById('sale-paid').addEventListener('input', recalcTotals);

// --- SAVE SALE ---
document.getElementById('sale-save').addEventListener('click', async ()=>{
  const msgEl=document.getElementById('sale-msg'); msgEl.textContent='';
  const customer=document.getElementById('sale-customer').value.trim();
  const paymentType=document.getElementById('sale-payment-type').value;
  const total=parseFloat(document.getElementById('sale-total').textContent)||0;
  let paid=parseFloat(document.getElementById('sale-paid').value)||0;
  if(total<=0){msgEl.textContent='Add at least one item'; return;}
  if(paid>total){paid=total; document.getElementById('sale-paid').value=total.toFixed(2);}
  if(paymentType==='BORROW' && !customer){msgEl.textContent='Customer required for borrow'; return;}

  const items=[];
  let valid=true;
  document.querySelectorAll('#sale-items-body tr').forEach(tr=>{
    const sel=tr.querySelector('.sale-product');
    const productId=parseInt(sel.value);
    const price=parseFloat(tr.querySelector('.sale-price').textContent)||0;
    const qty=parseInt(tr.querySelector('.sale-qty').value)||0;
    if(!productId||price<=0||qty<=0) valid=false;
    items.push({product_id:productId,price,quantity:qty});
  });
  if(!valid || items.length===0){msgEl.textContent='Invalid items'; return;}

  const data = await fetchJSON(`${API_BASE}?route=sales`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({customer_name:customer||null, payment_type:paymentType, total_amount:total, paid_amount:paid, items})
  });
  if(data){msgEl.textContent='Sale saved'; document.getElementById('sale-customer').value=''; document.getElementById('sale-items-body').innerHTML=''; document.getElementById('sale-paid').value='0'; recalcTotals(); loadStock(); loadDashboard(); loadBills(); }
  else msgEl.textContent='Error saving sale';
});

// --- SALES BILLS ---
async function loadBills(){
  const data = await fetchJSON(`${API_BASE}?route=sales`);
  if(!data) return;
  const tbody=document.getElementById('bills-table-body'); tbody.innerHTML='';
  data.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${row.date}</td><td>${row.customer||''}</td><td>${row.payment_type}</td><td>${Number(row.total_amount).toFixed(2)}</td><td>${Number(row.paid_amount).toFixed(2)}</td><td>${Number(row.borrow_amount||0).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

// --- BORROWERS ---
async function loadBorrowers(){
  const data = await fetchJSON(`${API_BASE}?route=borrowers`);
  if(!data) return;
  const tbody=document.getElementById('borrowers-table-body'); tbody.innerHTML='';
  data.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${row.name}</td><td>${Number(row.outstanding).toFixed(2)}</td><td><button class="pay-btn">Pay</button></td>`;
    tbody.appendChild(tr);
    const btn = tr.querySelector('.pay-btn');
    btn.addEventListener('click', async ()=>{
      const amt=prompt('Enter payment amount:',row.outstanding);
      const numAmt=parseFloat(amt)||0;
      if(numAmt<=0 || numAmt>row.outstanding) {alert('Invalid amount'); return;}
      const res = await fetchJSON(`${API_BASE}?route=borrower-payments`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({borrower_id:row.id, amount:numAmt})
      });
      if(res){alert('Payment saved'); loadBorrowers(); loadDashboard(); loadBills();}
      else alert('Error saving payment');
    });
  });
}
</script>
</body>
</html>


