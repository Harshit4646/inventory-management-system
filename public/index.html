<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Management System</title>
  <style>
/* ================= GLOBAL ================= */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
  background: radial-gradient(circle at top, #1e3c72 0%, #0f2027 40%, #0b132b 100%);
  min-height: 100vh;
  color: #eaeaea;
}

/* ================= HEADER ================= */
header {
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.08);
  border-bottom: 1px solid rgba(255,255,255,0.15);
  padding: 16px 30px;
  position: sticky;
  top: 0;
  z-index: 100;
}

nav a {
  color: #fff;
  margin-right: 24px;
  text-decoration: none;
  font-weight: 600;
  letter-spacing: 0.3px;
  position: relative;
  padding-bottom: 6px;
  transition: all 0.3s ease;
}

nav a::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: 0;
  width: 0%;
  height: 3px;
  background: linear-gradient(90deg, #ffd700, #ff8c00);
  transition: width 0.3s ease;
  border-radius: 5px;
}

nav a:hover::after,
nav a.active::after {
  width: 100%;
}

/* ================= MAIN ================= */
main {
  padding: 30px;
}

section {
  display: none;
  animation: fadeSlide 0.5s ease;
}

section.active {
  display: block;
}

@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ================= HEADINGS ================= */
h2 {
  color: #ffd700;
  margin-bottom: 15px;
}

h3 {
  color: #bfc9ff;
  margin-top: 25px;
}

/* ================= DASHBOARD ================= */
.flex {
  display: flex;
  flex-wrap: wrap;
  gap: 22px;
}

.card {
  background: linear-gradient(135deg, rgba(255,255,255,0.18), rgba(255,255,255,0.06));
  backdrop-filter: blur(14px);
  border-radius: 18px;
  padding: 20px;
  min-width: 210px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
  transition: all 0.3s ease;
  border: 1px solid rgba(255,255,255,0.2);
}

.card:hover {
  transform: translateY(-8px) scale(1.03);
  box-shadow: 0 20px 45px rgba(0,0,0,0.6);
}

.card span {
  font-size: 20px;
  font-weight: 700;
}

/* ================= PILLS ================= */
.pill {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 30px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.4px;
}

.pill.cash {
  background: linear-gradient(90deg, #43e97b, #38f9d7);
  color: #003b2f;
}

.pill.online {
  background: linear-gradient(90deg, #4facfe, #00f2fe);
  color: #002f4b;
}

.pill.borrow {
  background: linear-gradient(90deg, #fa709a, #fee140);
  color: #4b1c00;
}

/* ================= FORMS ================= */
.form-row {
  margin-bottom: 14px;
}

label {
  display: inline-block;
  width: 160px;
  font-weight: 600;
  color: #ddd;
}

input, select {
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.25);
  background: rgba(255,255,255,0.12);
  color: #fff;
  font-size: 14px;
}

input:focus, select:focus {
  outline: none;
  border-color: #ffd700;
  box-shadow: 0 0 0 2px rgba(255,215,0,0.3);
}

/* ================= BUTTONS ================= */
button {
  padding: 9px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 700;
  letter-spacing: 0.4px;
  transition: all 0.25s ease;
}

button:hover {
  transform: translateY(-2px) scale(1.05);
}

.btn-primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
}

.btn-success {
  background: linear-gradient(135deg, #11998e, #38ef7d);
  color: #003f2d;
}

.btn-danger {
  background: linear-gradient(135deg, #ff416c, #ff4b2b);
  color: #fff;
}

.btn-warning {
  background: linear-gradient(135deg, #f7971e, #ffd200);
  color: #3b2500;
}

.btn-secondary {
  background: linear-gradient(135deg, #485563, #29323c);
  color: #fff;
}

/* ================= TABLES ================= */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

th {
  background: rgba(255,255,255,0.18);
  padding: 12px;
  font-size: 14px;
}

td {
  padding: 11px;
  font-size: 13.5px;
  border-top: 1px solid rgba(255,255,255,0.15);
}

tr {
  transition: all 0.25s ease;
}

tr:hover td {
  background: rgba(255,255,255,0.15);
}

/* ================= STATUS ================= */
.near-expiry {
  background: rgba(255,193,7,0.25) !important;
}

.expired {
  background: rgba(220,53,69,0.3) !important;
}

/* ================= MESSAGES ================= */
.msg {
  padding: 12px;
  margin: 12px 0;
  border-radius: 10px;
  font-weight: 700;
}

.msg.success {
  background: rgba(40,167,69,0.25);
  color: #7CFFB2;
}

.msg.error {
  background: rgba(220,53,69,0.25);
  color: #FF9C9C;
}

/* ================= BILL DETAILS ================= */
.bill-detail {
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(14px);
  padding: 20px;
  border-radius: 18px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.6);
}

/* ================= TOTALS ================= */
.bills-filter-bar,
.bills-totals {
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(12px);
  padding: 16px;
  border-radius: 16px;
  margin-top: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  label {
    width: 100%;
    margin-bottom: 6px;
  }

  input, select {
    width: 100%;
  }

  .flex {
    flex-direction: column;
  }
}
</style>

</head>
<body>
<header>
  <nav>
    <a href="#" data-section="dashboard" class="active">Dashboard</a>
    <a href="#" data-section="stock">Stock</a>
    <a href="#" data-section="expired">Expired</a>
    <a href="#" data-section="sales">New Sale</a>
    <a href="#" data-section="bills">Sales Bills</a>
    <a href="#" data-section="borrowers">Borrowers</a>
  </nav>
</header>
<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="active">
    <h2>Dashboard</h2>
    <div class="flex">
      <div class="card">
        <strong>Daily Sales</strong><br>
        ₹ <span id="dash-daily-total">0</span>
      </div>
      <div class="card">
        <strong>Monthly Sales</strong><br>
        ₹ <span id="dash-monthly-total">0</span>
      </div>
      <div class="card">
        <span class="pill cash">Cash</span>
        ₹ <span id="dash-daily-cash">0</span>
      </div>
      <div class="card">
        <span class="pill online">Online</span>
        ₹ <span id="dash-daily-online">0</span>
      </div>
      <div class="card">
        <span class="pill borrow">Borrow Sales</span>
        ₹ <span id="dash-daily-borrow">0</span>
      </div>
      <div class="card">
        <strong>Borrower Payments Today</strong><br>
        ₹ <span id="dash-borrower-payments">0</span>
      </div>
    </div>
  </section>

  <!-- STOCK -->
  <section id="stock">
    <h2>Stock</h2>
    <h3>Add / Update Stock</h3>
    <div>
      <div class="form-row">
        <label>Product name:</label>
        <input id="stock-name" type="text" placeholder="Enter product name">
      </div>
      <div class="form-row">
        <label>Price (₹):</label>
        <input id="stock-price" type="number" step="0.01" min="0">
      </div>
      <div class="form-row">
        <label>Expiry date:</label>
        <input id="stock-expiry" type="date">
      </div>
      <div class="form-row">
        <label>Quantity:</label>
        <input id="stock-qty" type="number" min="1">
      </div>
      <button id="stock-add-btn" class="btn-primary">Add / Increase Stock</button>
      <div id="stock-msg"></div>
    </div>
    <h3>Current Stock</h3>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="stock-table-body"></tbody>
    </table>
  </section>

  <!-- EXPIRED -->
  <section id="expired">
    <h2>Expired Stock</h2>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Expired Date</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody id="expired-table-body"></tbody>
    </table>
  </section>

  <!-- NEW SALE / EDIT BILL -->
  <section id="sales">
    <h2 id="sales-title">New Sale</h2>
    <button id="cancel-edit-btn" class="btn-danger" style="display:none; margin-bottom:10px;">Cancel Edit</button>
    
    <div class="form-row">
      <label>Customer name:</label>
      <input id="sale-customer" type="text" placeholder="Customer name (required for BORROW)">
    </div>
    <div class="form-row">
      <label>Payment type:</label>
      <select id="sale-payment-type">
        <option value="CASH">CASH</option>
        <option value="ONLINE">ONLINE</option>
        <option value="BORROW">BORROW</option>
      </select>
    </div>
    <h3>Items</h3>
    <button id="sale-add-item" class="btn-success">Add Item</button>
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Qty</th>
          <th>Line Total</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody id="sale-items-body"></tbody>
    </table>
    <div class="form-row">
      <label>Total:</label>
      <span id="sale-total" style="font-size: 18px; font-weight: bold;">₹0.00</span>
    </div>
    <div class="form-row">
      <label>Discount:</label>
      <input id="sale-discount" type="number" step="0.01" value="0" min="0">
    </div>
    <div class="form-row">
      <label>Paid amount:</label>
      <input id="sale-paid" type="number" step="0.01" value="0" min="0">
    </div>
    <div class="form-row">
      <label>Remaining:</label>
      <span id="sale-remaining" style="color: #dc3545; font-weight: bold;">₹0.00</span>
    </div>
    <button id="sale-save" class="btn-primary">Save Sale</button>
    <div id="sale-msg"></div>
  </section>

  <!-- SALES BILLS -->
  <section id="bills">
    <h2>Sales Bills</h2>

    <!-- FILTER BAR -->
    <div class="bills-filter-bar">
      <label for="bill-filter-type">Filter:</label>
      <select id="bill-filter-type">
        <option value="ALL">All</option>
        <option value="MONTH">Month</option>
        <option value="DAY">Day</option>
      </select>
      <span id="bill-filter-inputs">
        <!-- For MONTH -->
        <span id="bill-filter-month-wrapper" style="display:none;">
          <label for="bill-filter-month">Month:</label>
          <input type="month" id="bill-filter-month">
        </span>
        <!-- For DAY -->
        <span id="bill-filter-day-wrapper" style="display:none;">
          <label for="bill-filter-day">Date:</label>
          <input type="date" id="bill-filter-day">
        </span>
      </span>
      <button id="bill-filter-apply" class="btn-primary">Apply</button>
    </div>

    <div id="bill-detail-container" style="display: none;">
      <h3>Bill Details</h3>
      <div id="bill-detail" class="bill-detail"></div>
      <div style="margin-top: 10px;">
        <button id="edit-bill-btn" class="btn-warning">Edit Bill</button>
        <button id="delete-bill-btn" class="btn-danger">Delete Bill</button>
        <button id="print-bill-btn" class="btn-primary">Print Bill</button>
        <button id="close-bill-detail" class="btn-secondary">Close</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Payment Type</th>
          <th>Total</th>
          <th>Discount</th>
          <th>Paid</th>
          <th>Borrow</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="bills-table-body"></tbody>
    </table>

    <!-- TOTALS FOR CURRENT FILTER -->
    <div class="bills-totals">
      <div><strong>Total Cash:</strong> ₹<span id="bills-total-cash">0.00</span></div>
      <div><strong>Total Online:</strong> ₹<span id="bills-total-online">0.00</span></div>
      <div><strong>Total Borrow (Sales):</strong> ₹<span id="bills-total-borrow">0.00</span></div>
      <div><strong>Total Borrower Payments:</strong> ₹<span id="bills-total-borrower-payments">0.00</span></div>
    </div>
  </section>

  <!-- BORROWERS -->
  <section id="borrowers">
    <h2>Borrowers</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Outstanding</th>
          <th>Last Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="borrowers-table-body"></tbody>
    </table>
  </section>
</main>

<script>
const API_BASE = '/api/server';

// --- MESSAGE HELPER ---
function showMsg(el, msg, type = 'success') {
  el.innerHTML = `<div class="msg ${type}">${msg}</div>`;
  setTimeout(() => el.innerHTML = '', 5000);
}

// Helper: format only date from value (string or Date)
function formatOnlyDate(value) {
  if (!value) return '';
  const d = new Date(value);
  if (isNaN(d.getTime())) return value;
  return d.toLocaleDateString('en-GB'); // DD/MM/YYYY [web:15]
}

// --- NAVIGATION ---
document.querySelectorAll('nav a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const sec = a.dataset.section;
    document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('main section').forEach(s => s.classList.remove('active'));
    document.getElementById(sec).classList.add('active');

    if (sec === 'dashboard') loadDashboard();
    if (sec === 'stock') loadStock();
    if (sec === 'expired') loadExpired();
    if (sec === 'sales') {
      loadSaleProducts();
    }
    if (sec === 'bills') loadBills();
    if (sec === 'borrowers') loadBorrowers();
  });
});

// --- FETCH WRAPPER ---
async function fetchJSON(url, options = {}) {
  try {
    const res = await fetch(url, options);
    if (!res.ok) {
      const text = await res.text();
      console.error(`HTTP ${res.status}: ${text}`);
      return null;
    }
    return await res.json();
  } catch (err) {
    console.error('Fetch error:', err);
    return null;
  }
}

// --- DASHBOARD ---
async function loadDashboard() {
  const data = await fetchJSON(`${API_BASE}?route=dashboard`);
  if (!data) return;
  document.getElementById('dash-daily-total').textContent = Number(data.daily_total).toFixed(2);
  document.getElementById('dash-monthly-total').textContent = Number(data.monthly_total).toFixed(2);
  document.getElementById('dash-daily-cash').textContent = Number(data.daily_cash).toFixed(2);
  document.getElementById('dash-daily-online').textContent = Number(data.daily_online).toFixed(2);
  document.getElementById('dash-daily-borrow').textContent = Number(data.daily_borrow).toFixed(2);
  document.getElementById('dash-borrower-payments').textContent = Number(data.borrower_payments).toFixed(2);
}

// --- STOCK ---
async function loadStock() {
  const data = await fetchJSON(`${API_BASE}?route=stock`);
  if (!data) return;
  const tbody = document.getElementById('stock-table-body');
  tbody.innerHTML = '';
  const today = new Date();
  data.forEach(row => {
    const tr = document.createElement('tr');
    const exp = new Date(row.expiry_date);
    if ((exp - today) / (1000 * 60 * 60 * 24) <= 7) tr.classList.add('near-expiry');
    tr.innerHTML = `<td>${row.name}</td><td>₹${Number(row.price).toFixed(2)}</td><td>${formatOnlyDate(row.expiry_date)}</td><td>${row.quantity}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('stock-add-btn').addEventListener('click', async () => {
  const name = document.getElementById('stock-name').value.trim();
  const price = parseFloat(document.getElementById('stock-price').value);
  const expiry = document.getElementById('stock-expiry').value;
  const qty = parseInt(document.getElementById('stock-qty').value);
  const msgEl = document.getElementById('stock-msg');
  
  if (!name || !price || !expiry || !qty) {
    showMsg(msgEl, 'Fill all fields', 'error');
    return;
  }
  
  const data = await fetchJSON(`${API_BASE}?route=stock`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, price, expiry_date: expiry, quantity: qty })
  });
  
  if (data && data.success) {
    showMsg(msgEl, 'Stock saved successfully');
    document.getElementById('stock-name').value = '';
    document.getElementById('stock-price').value = '';
    document.getElementById('stock-expiry').value = '';
    document.getElementById('stock-qty').value = '';
    loadStock();
  } else {
    showMsg(msgEl, 'Error saving stock', 'error');
  }
});

// --- EXPIRED ---
async function loadExpired() {
  const data = await fetchJSON(`${API_BASE}?route=expired`);
  if (!data) return;
  const tbody = document.getElementById('expired-table-body');
  tbody.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.classList.add('expired');
    tr.innerHTML = `<td>${row.name}</td><td>₹${Number(row.price).toFixed(2)}</td><td>${formatOnlyDate(row.expiry_date)}</td><td>${formatOnlyDate(row.expired_date)}</td><td>${row.quantity}</td>`;
    tbody.appendChild(tr);
  });
}

// --- SALES PRODUCTS & NEW SALE ---
let saleProducts = [];
let currentBillId = null;
let isLoadingEditBill = false;
let lastBillData = null; // for printing

async function loadSaleProducts() {
  const data = await fetchJSON(`${API_BASE}?route=sale-products`);
  if (data) saleProducts = data;
}

function recalcTotals() {
  let total = 0;
  document.querySelectorAll('#sale-items-body tr').forEach(tr => {
    const price = parseFloat(tr.querySelector('.sale-price')?.textContent.replace('₹', '')) || 0;
    const qty = parseInt(tr.querySelector('.sale-qty')?.value) || 0;
    const line = price * qty;
    tr.querySelector('.sale-line-total').textContent = `₹${line.toFixed(2)}`;
    total += line;
  });
  document.getElementById('sale-total').textContent = `₹${total.toFixed(2)}`;
  
  const discount = parseFloat(document.getElementById('sale-discount').value) || 0;
  const paid = parseFloat(document.getElementById('sale-paid').value) || 0;
  let remaining = total - discount - paid;
  if (remaining < 0) {
    document.getElementById('sale-paid').value = (total - discount).toFixed(2);
    remaining = 0;
  }
  document.getElementById('sale-remaining').textContent = `₹${remaining.toFixed(2)}`;
}

function handleProductChange(e) {
  const tr = e.target.closest('tr');
  const id = parseInt(e.target.value);
  const product = saleProducts.find(p => p.id === id);
  if (product) {
    tr.querySelector('.sale-price').textContent = `₹${Number(product.price).toFixed(2)}`;
    tr.querySelector('.sale-expiry').textContent = formatOnlyDate(product.expiry_date);
  } else {
    tr.querySelector('.sale-price').textContent = '₹0.00';
    tr.querySelector('.sale-expiry').textContent = '';
  }
  recalcTotals();
}

function handleQtyChange(e) {
  const tr = e.target.closest('tr');
  const id = parseInt(tr.querySelector('.sale-product').value);
  const product = saleProducts.find(p => p.id === id);
  let qty = parseInt(e.target.value) || 0;
  if (product && qty > product.quantity) qty = product.quantity;
  if (qty < 1) qty = 1;
  e.target.value = qty;
  recalcTotals();
}

document.getElementById('sale-add-item').addEventListener('click', () => {
  const tbody = document.getElementById('sale-items-body');
  const tr = document.createElement('tr');
  const options = saleProducts.map(p => 
    `<option value="${p.id}">${p.name} | ₹${p.price} | Exp:${formatOnlyDate(p.expiry_date)} | Stock:${p.quantity}</option>`
  ).join('');
  
  tr.innerHTML = `
    <td><select class="sale-product"><option value="">Select...</option>${options}</select></td>
    <td class="sale-price">₹0.00</td>
    <td class="sale-expiry"></td>
    <td><input class="sale-qty" type="number" min="1" value="1" style="width:60px"></td>
    <td class="sale-line-total">₹0.00</td>
    <td><button class="sale-remove btn-danger" style="font-size:12px;padding:2px 6px;">X</button></td>
  `;
  tbody.appendChild(tr);

  const sel = tr.querySelector('.sale-product');
  const qtyInput = tr.querySelector('.sale-qty');

  sel.addEventListener('change', handleProductChange);
  qtyInput.addEventListener('input', handleQtyChange);
  tr.querySelector('.sale-remove').addEventListener('click', () => {
    tr.remove();
    recalcTotals();
  });
});

document.getElementById('sale-discount').addEventListener('input', recalcTotals);
document.getElementById('sale-paid').addEventListener('input', recalcTotals);

document.getElementById('sale-save').addEventListener('click', async () => {
  const msgEl = document.getElementById('sale-msg');
  const customer = document.getElementById('sale-customer').value.trim();
  const paymentType = document.getElementById('sale-payment-type').value;
  const total = parseFloat(document.getElementById('sale-total').textContent.replace('₹', '')) || 0;
  let discount = parseFloat(document.getElementById('sale-discount').value) || 0;
  let paid = parseFloat(document.getElementById('sale-paid').value) || 0;

  if (total <= 0) {
    showMsg(msgEl, 'Add at least one item', 'error');
    return;
  }
  if (paid > total - discount) {
    paid = total - discount;
    document.getElementById('sale-paid').value = (total - discount).toFixed(2);
  }
  if (paymentType === 'BORROW' && !customer) {
    showMsg(msgEl, 'Customer required for borrow', 'error');
    return;
  }

  const items = [];
  let valid = true;
  document.querySelectorAll('#sale-items-body tr').forEach(tr => {
    const sel = tr.querySelector('.sale-product');
    const productId = parseInt(sel.value);
    const price = parseFloat(tr.querySelector('.sale-price').textContent.replace('₹', '')) || 0;
    const qty = parseInt(tr.querySelector('.sale-qty').value) || 0;
    if (!productId || price <= 0 || qty <= 0) valid = false;
    items.push({ product_id: productId, price, quantity: qty });
  });

  if (!valid || items.length === 0) {
    showMsg(msgEl, 'Invalid items', 'error');
    return;
  }

  const isEdit = !!currentBillId;
  const route = isEdit ? 'edit-bill' : 'sales';
  const body = {
    ...(isEdit && { sale_id: currentBillId }),
    customer_name: customer || null,
    payment_type: paymentType,
    total_amount: total,
    discount_amount: discount,
    paid_amount: paid,
    items
  };

  const data = await fetchJSON(`${API_BASE}?route=${route}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (data && data.success) {
    showMsg(msgEl, `Bill ${isEdit ? 'updated' : 'saved'} successfully`);
    resetSaleForm();
    loadStock();
    loadDashboard();
    loadBills();
  } else {
    showMsg(msgEl, 'Error saving sale', 'error');
  }
});

function resetSaleForm() {
  document.getElementById('sales-title').textContent = 'New Sale';
  document.getElementById('cancel-edit-btn').style.display = 'none';
  document.getElementById('sale-save').textContent = 'Save Sale';
  document.getElementById('sale-items-body').innerHTML = '';
  document.getElementById('sale-customer').value = '';
  document.getElementById('sale-discount').value = '0';
  document.getElementById('sale-paid').value = '0';
  currentBillId = null;
  isLoadingEditBill = false;
  recalcTotals();
}

// Add existing items when editing
function addEditItem(item) {
  const tbody = document.getElementById('sale-items-body');
  const product = saleProducts.find(p => p.id == item.product_id);
  if (!product) return;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><select class="sale-product"><option value="${product.id}">${product.name}</option></select></td>
    <td class="sale-price">₹${Number(item.price).toFixed(2)}</td>
    <td class="sale-expiry">${formatOnlyDate(product.expiry_date || '')}</td>
    <td><input class="sale-qty" type="number" min="1" value="${item.quantity}" style="width:60px"></td>
    <td class="sale-line-total">₹${(item.price * item.quantity).toFixed(2)}</td>
    <td><button class="sale-remove btn-danger" style="font-size:12px;padding:2px 6px;">X</button></td>
  `;
  
  tbody.appendChild(tr);
  
  const sel = tr.querySelector('.sale-product');
  const qtyInput = tr.querySelector('.sale-qty');
  
  sel.addEventListener('change', handleProductChange);
  qtyInput.addEventListener('input', handleQtyChange);
  tr.querySelector('.sale-remove').addEventListener('click', () => {
    tr.remove();
    recalcTotals();
  });
}

// Load bill into New Sale for editing
async function editBill(saleId) {
  resetSaleForm();
  currentBillId = saleId;

  const data = await fetchJSON(`${API_BASE}?route=bill-detail&sale_id=${saleId}`);
  if (!data || !data.sale) return;

  document.getElementById('sales-title').textContent = `Edit Bill #${data.sale.id}`;
  document.getElementById('cancel-edit-btn').style.display = 'inline-block';
  document.getElementById('sale-save').textContent = 'Update Bill';

  document.getElementById('sale-customer').value = data.sale.customer_name || '';
  document.getElementById('sale-payment-type').value = data.sale.payment_type;
  document.getElementById('sale-discount').value = Number(data.sale.discount_amount).toFixed(2);
  document.getElementById('sale-paid').value = Number(data.sale.paid_amount).toFixed(2);

  data.items.forEach(addEditItem);
  recalcTotals();
}

// no auto edit mode
function checkEditMode() {}

// Cancel Edit
document.getElementById('cancel-edit-btn').addEventListener('click', () => {
  resetSaleForm();
  if (document.querySelector('nav a.active').dataset.section === 'sales') {
    document.querySelector('a[data-section="bills"]').click();
  }
});

// --- SALES BILLS ---
// keep all bills in memory for filtering
let allBills = [];

function applyBillsFilterAndRender() {
  const filterType = document.getElementById('bill-filter-type').value;
  const monthVal = document.getElementById('bill-filter-month').value; // YYYY-MM
  const dayVal = document.getElementById('bill-filter-day').value;     // YYYY-MM-DD
  const tbody = document.getElementById('bills-table-body');
  if (!tbody) return;
  tbody.innerHTML = '';

  let filtered = allBills.slice();

  if (filterType === 'MONTH' && monthVal) {
    const [year, month] = monthVal.split('-').map(Number);
    filtered = allBills.filter(bill => {
      if (!bill.sale_date) return false;
      const d = new Date(bill.sale_date);
      return d.getFullYear() === year && (d.getMonth() + 1) === month;
    });
  } else if (filterType === 'DAY' && dayVal) {
    filtered = allBills.filter(bill => {
      if (!bill.sale_date) return false;
      // Compare only date part
      const dStr = new Date(bill.sale_date).toISOString().slice(0, 10);
      return dStr === dayVal;
    });
  }

  let totalCash = 0;
  let totalOnline = 0;
  let totalBorrow = 0;
  let totalBorrowerPayments = 0;

  filtered.forEach(bill => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatOnlyDate(bill.sale_date || '')}</td>
      <td>${bill.customer_name || 'Walk-in'}</td>
      <td>${bill.payment_type}</td>
      <td>₹${Number(bill.total_amount).toFixed(2)}</td>
      <td>₹${Number(bill.discount_amount).toFixed(2)}</td>
      <td>₹${Number(bill.paid_amount).toFixed(2)}</td>
      <td>₹${Number(bill.borrow_amount || 0).toFixed(2)}</td>
      <td class="actions">
        <button class="view-btn btn-secondary" data-sale-id="${bill.id}">View</button>
      </td>
    `;
    tbody.appendChild(tr);

    if (bill.payment_type === 'CASH') {
      totalCash += Number(bill.paid_amount || 0);
    } else if (bill.payment_type === 'ONLINE') {
      totalOnline += Number(bill.paid_amount || 0);
    } else if (bill.payment_type === 'BORROW') {
      totalBorrow += Number(bill.borrow_amount || 0);
      totalBorrowerPayments += Number(bill.paid_amount || 0);
    }
  });

  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const saleId = e.target.dataset.saleId;
      showBillDetail(saleId);
    });
  });

  document.getElementById('bills-total-cash').textContent = totalCash.toFixed(2);
  document.getElementById('bills-total-online').textContent = totalOnline.toFixed(2);
  document.getElementById('bills-total-borrow').textContent = totalBorrow.toFixed(2);
  document.getElementById('bills-total-borrower-payments').textContent = totalBorrowerPayments.toFixed(2);
}

async function loadBills() {
  const bills = await fetchJSON(`${API_BASE}?route=bills`);
  if (!bills) return;
  allBills = bills;
  applyBillsFilterAndRender();
}

// handle filter UI changes
document.getElementById('bill-filter-type').addEventListener('change', () => {
  const type = document.getElementById('bill-filter-type').value;
  document.getElementById('bill-filter-month-wrapper').style.display = (type === 'MONTH') ? 'inline-block' : 'none';
  document.getElementById('bill-filter-day-wrapper').style.display = (type === 'DAY') ? 'inline-block' : 'none';
});

document.getElementById('bill-filter-apply').addEventListener('click', () => {
  applyBillsFilterAndRender();
});

// --- BILL DETAIL POPUP ---
async function showBillDetail(saleId) {
  const data = await fetchJSON(`${API_BASE}?route=bill-detail&sale_id=${saleId}`);
  if (!data) return;

  currentBillId = saleId;
  lastBillData = data; // for printing

  const container = document.getElementById('bill-detail-container');
  const detailEl = document.getElementById('bill-detail');
  
  detailEl.innerHTML = `
    <h4>Bill #${data.sale.id} - ${formatOnlyDate(data.sale.sale_date)}</h4>
    <p><strong>Customer:</strong> ${data.sale.customer_name || 'Walk-in'}</p>
    <p><strong>Payment Type:</strong> <span class="pill ${data.sale.payment_type.toLowerCase()}">${data.sale.payment_type}</span></p>
    <p><strong>Total:</strong> ₹${Number(data.sale.total_amount).toFixed(2)}</p>
    <p><strong>Discount:</strong> ₹${Number(data.sale.discount_amount).toFixed(2)}</p>
    <p><strong>Paid:</strong> ₹${Number(data.sale.paid_amount).toFixed(2)}</p>
    <p><strong>Balance:</strong> ₹${Number(data.sale.borrow_amount).toFixed(2)}</p>
    <h5>Items:</h5>
    <table style="width:100%; margin-top:10px;">
      <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead>
      <tbody>
        ${data.items.map(item => 
          `<tr><td>${item.name}</td><td>₹${Number(item.price).toFixed(2)}</td><td>${item.quantity}</td><td>₹${Number(item.line_total).toFixed(2)}</td></tr>`
        ).join('')}
      </tbody>
    </table>
  `;
  
  container.style.display = 'block';
  container.scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('close-bill-detail').addEventListener('click', () => {
  document.getElementById('bill-detail-container').style.display = 'none';
});

document.getElementById('edit-bill-btn').addEventListener('click', async () => {
  if (!currentBillId) return;
  document.querySelector('a[data-section="sales"]').click();
  await loadSaleProducts();
  editBill(currentBillId);
  document.getElementById('bill-detail-container').style.display = 'none';
});

document.getElementById('delete-bill-btn').addEventListener('click', async () => {
  if (!currentBillId || !confirm('Delete this bill? This will restore stock.')) return;
  
  const data = await fetchJSON(`${API_BASE}?route=delete-bill`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sale_id: currentBillId })
  });
  
  if (data && data.success) {
    alert('Bill deleted successfully');
    document.getElementById('bill-detail-container').style.display = 'none';
    loadBills();
    loadStock();
    loadDashboard();
  } else {
    alert('Error deleting bill');
  }
});

// PRINT BILL
document.getElementById('print-bill-btn').addEventListener('click', () => {
  if (!lastBillData || !lastBillData.sale) {
    alert('No bill loaded to print');
    return;
  }

  const { sale, items } = lastBillData;

  const win = window.open('', '_blank', 'width=600,height=800');
  win.document.write(`
    <html>
    <head>
      <title>Bill #${sale.id}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2, h3 { margin: 0 0 10px 0; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #000; padding: 6px; font-size: 13px; }
        th { background: #f0f0f0; }
        .totals { margin-top: 15px; }
        .totals p { margin: 3px 0; }
        @media print {
          button { display: none; }
        }
      </style>
    </head>
    <body>
      <h2>Invoice / Bill</h2>
      <p><strong>Bill No:</strong> ${sale.id}</p>
      <p><strong>Date:</strong> ${formatOnlyDate(sale.sale_date)}</p>
      <p><strong>Customer:</strong> ${sale.customer_name || 'Walk-in'}</p>
      <p><strong>Payment Type:</strong> ${sale.payment_type}</p>

      <h3>Items</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Product</th>
            <th>Price (₹)</th>
            <th>Qty</th>
            <th>Total (₹)</th>
          </tr>
        </thead>
        <tbody>
          ${items.map((item, idx) => `
            <tr>
              <td>${idx + 1}</td>
              <td>${item.name}</td>
              <td>${Number(item.price).toFixed(2)}</td>
              <td>${item.quantity}</td>
              <td>${Number(item.line_total).toFixed(2)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <div class="totals">
        <p><strong>Total:</strong> ₹${Number(sale.total_amount).toFixed(2)}</p>
        <p><strong>Discount:</strong> ₹${Number(sale.discount_amount).toFixed(2)}</p>
        <p><strong>Paid:</strong> ₹${Number(sale.paid_amount).toFixed(2)}</p>
        <p><strong>Balance:</strong> ₹${Number(sale.borrow_amount).toFixed(2)}</p>
      </div>

      <p style="margin-top:25px;">Signature ____________________</p>

      <button onclick="window.print()">Print</button>
    </body>
    </html>
  `);
  win.document.close();
  win.focus();
  win.print();
});

// --- BORROWERS ---
async function loadBorrowers() {
  const data = await fetchJSON(`${API_BASE}?route=borrowers`);
  if (!data) return;
  const tbody = document.getElementById('borrowers-table-body');
  tbody.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${row.name}</strong></td>
      <td style="color: #dc3545; font-weight: bold;">₹${Number(row.outstanding_amount).toFixed(2)}</td>
      <td>${formatOnlyDate(new Date())}</td>
      <td>
        <button class="pay-btn btn-success" data-borrower-id="${row.id}" data-name="${row.name}">Pay</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.pay-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const borrowerId = e.target.dataset.borrowerId;
      const borrowerName = e.target.dataset.name;
      const amt = prompt(`Payment amount for ${borrowerName}:`, '0');
      const numAmt = parseFloat(amt);
      
      if (!numAmt || numAmt <= 0 || !borrowerId) {
        alert('Invalid amount or borrower');
        return;
      }

      const payload = { borrower_id: parseInt(borrowerId), amount: numAmt };
      console.log('Sending payload:', payload);

      const res = await fetchJSON(`${API_BASE}?route=borrower-payments`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (res && res.success) {
        alert('Payment recorded successfully');
        loadBorrowers();
        loadDashboard();
        loadBills();
      } else {
        console.error('Full response:', res);
        alert(`Error: ${res?.error || 'Unknown error'}`);
      }
    });
  });
}

// Load dashboard on page load
loadDashboard();
</script>
</body>
</html>



